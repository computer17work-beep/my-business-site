<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TM TOPUP - Free Fire Diamond</title>
    <style>
        :root{--accent:#ff4500;--bg:#f4fbff}
        body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:16px}
        header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        h1{color:var(--accent);margin:0}
        .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
        .btn.gray{background:#999}
        .btn.green{background:#28a745}
        .btn.blue{background:#007bff}
        .container{max-width:1000px;margin:0 auto}
        .card{background:#fff;border-radius:8px;padding:12px;margin:8px 0;border:1px solid #e5e5e5}
        .packages{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
        .package{padding:12px;border:1px solid #eee;border-radius:8px;display:flex;flex-direction:column;gap:8px}
        .package .price{font-weight:700;color:var(--accent)}
        .package-type{background:#e7f3ff;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;color:#0066cc}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;padding:12px}
        .modal .box{background:#fff;padding:16px;border-radius:8px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto}
        input,select,textarea{width:100%;padding:8px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th,td{border:1px solid #e6e6e6;padding:8px;text-align:center}
        th{background:var(--accent);color:#fff}
        .top-actions{display:flex;gap:8px;flex-wrap:wrap}
        .hidden{display:none}
        .flex{display:flex;gap:8px;align-items:center}
        small.note{color:#666}
        .instructions{background:#f0f8ff;padding:12px;border-radius:8px;margin:12px 0;border-left:4px solid var(--accent)}
        .instructions p{margin:8px 0}
        .order-notification{background:#e8f5e8;padding:12px;border-radius:8px;margin:8px 0;border-left:4px solid #4CAF50}
        .business-header{text-align:center;margin-bottom:20px}
        .business-logo{max-width:200px;height:auto;margin-bottom:10px;border-radius:10px}
        .banner-image{width:100%;max-height:200px;object-fit:cover;border-radius:10px;margin-bottom:15px}
        .section-title{color:var(--accent);margin:20px 0 10px 0;padding-bottom:5px;border-bottom:2px solid var(--accent)}
        .tab-buttons{display:flex;gap:10px;margin-bottom:15px}
        .tab-btn{background:#ddd;border:none;padding:10px 20px;border-radius:5px;cursor:pointer}
        .tab-btn.active{background:var(--accent);color:white}
        .status-pending{background:#fff3cd;color:#856404;padding:4px 8px;border-radius:12px;font-size:12px}
        .status-complete{background:#d4edda;color:#155724;padding:4px 8px;border-radius:12px;font-size:12px}
        .admin-section{margin:20px 0;padding:15px;background:#f8f9fa;border-radius:8px}
        .loading{text-align:center;padding:20px;color:#666}
        @media(max-width:600px){ .packages{grid-template-columns:1fr} }
    </style>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
<div class="container">
    <!-- Dynamic Banner -->
    <div id="bannerContainer" class="hidden">
        <img id="bannerImage" class="banner-image" src="" alt="TM TOPUP Banner">
    </div>

    <!-- Dynamic Logo & Business Header -->
    <div class="business-header">
        <img id="logoImage" class="business-logo" src="https://i.imgur.com/3UvHYH2.jpeg" alt="TM TOPUP">
        <h1 id="businessName">TM TOPUP - Free Fire Diamond</h1>
        <p id="businessTagline">Your Trusted Diamond Provider</p>
    </div>

    <header>
        <div></div>
        <div class="flex">
            <button class="btn" id="openAdminBtn">Admin Login</button>
            <button class="btn gray" id="viewAllOrdersBtn">All Orders</button>
        </div>
    </header>

    <!-- USER SECTION -->
    <section id="userSection">
        <div class="card">
            <h2>‡¶°‡¶æ‡¶Ø‡¶º‡¶Æ‡¶®‡ßç‡¶° ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú</h2>
            <div class="instructions">
                <p><strong>‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá:</strong> +8801755368404 ‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏‡ßá Transaction ID ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p>
                <p><strong>‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®:</strong> +8801755368404</p>
            </div>
            
            <!-- Tab Buttons -->
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showPackageType('diamond')">Diamond Topup</button>
                <button class="tab-btn" onclick="showPackageType('weekly')">Weekly & Monthly</button>
            </div>
            
            <!-- Diamond Topup Packages -->
            <div id="diamondPackages" class="packages-section">
                <h3 class="section-title">üíé Diamond Topup</h3>
                <div id="diamondPackagesContainer" class="packages">
                    <div class="loading">Loading packages...</div>
                </div>
            </div>
            
            <!-- Weekly & Monthly Packages -->
            <div id="weeklyPackages" class="packages-section hidden">
                <h3 class="section-title">üìÖ Weekly & Monthly Packages</h3>
                <div id="weeklyPackagesContainer" class="packages">
                    <div class="loading">Loading packages...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- ALL ORDERS SECTION -->
    <section id="allOrdersSection" class="hidden">
        <div class="card">
            <h2>‡¶∏‡¶¨ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ (Admin View)</h2>
            <div class="top-actions">
                <button class="btn gray" id="backToShopFromAdmin">Back to Shop</button>
                <button class="btn" id="refreshOrdersBtn">Refresh Orders</button>
            </div>
            <div id="ordersList">
                <div class="loading">Loading orders...</div>
            </div>
        </div>
    </section>

    <!-- ADMIN PANEL -->
    <section id="adminPanel" class="hidden">
        <div class="card">
            <h2>Admin Panel</h2>
            <div class="top-actions">
                <button class="btn gray" id="logoutAdmin">Logout</button>
                <button class="btn" id="refreshAdminData">Refresh</button>
                <button class="btn green" id="changeCredentialsBtn">Change Password</button>
                <button class="btn blue" id="manageAppearanceBtn">Manage Appearance</button>
            </div>

            <!-- Appearance Management -->
            <div class="admin-section">
                <h3>üé® Website Appearance</h3>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:15px 0">
                    <div>
                        <h4>Logo Settings</h4>
                        <input type="text" id="logoUrl" placeholder="Logo Image URL" style="margin-bottom:8px">
                        <button class="btn" onclick="updateLogo()">Update Logo</button>
                    </div>
                    
                    <div>
                        <h4>Banner Settings</h4>
                        <input type="text" id="bannerUrl" placeholder="Banner Image URL" style="margin-bottom:8px">
                        <button class="btn" onclick="updateBanner()">Update Banner</button>
                    </div>
                </div>

                <div style="margin:15px 0">
                    <h4>Business Info</h4>
                    <input type="text" id="businessNameInput" placeholder="Business Name" style="margin-bottom:8px">
                    <input type="text" id="businessTaglineInput" placeholder="Business Tagline" style="margin-bottom:8px">
                    <button class="btn" onclick="updateBusinessInfo()">Update Business Info</button>
                </div>

                <div style="margin:15px 0">
                    <h4>Contact Info</h4>
                    <input type="text" id="contactNumber" placeholder="Contact Number" style="margin-bottom:8px">
                    <input type="text" id="whatsappNumber" placeholder="WhatsApp Number" style="margin-bottom:8px">
                    <button class="btn" onclick="updateContactInfo()">Update Contact Info</button>
                </div>
            </div>

            <!-- Diamond Packages Management -->
            <h3 style="margin-top:20px">üíé Diamond Topup Packages</h3>
            <div id="adminDiamondPackageList">
                <div class="loading">Loading packages...</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                <input id="newDiamondPkgName" placeholder="Package name (e.g., 125 Diamonds)">
                <input id="newDiamondPkgPrice" placeholder="Price" type="number" min="0" step="1">
                <button class="btn" id="addDiamondPkgBtn">Add Diamond Package</button>
            </div>

            <!-- Weekly Packages Management -->
            <h3 style="margin-top:20px">üìÖ Weekly & Monthly Packages</h3>
            <div id="adminWeeklyPackageList">
                <div class="loading">Loading packages...</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                <input id="newWeeklyPkgName" placeholder="Package name (e.g., Weekly Pass)">
                <input id="newWeeklyPkgPrice" placeholder="Price" type="number" min="0" step="1">
                <button class="btn" id="addWeeklyPkgBtn">Add Weekly Package</button>
            </div>

            <!-- Orders Management -->
            <h3 style="margin-top:20px">üì¶ Orders Management</h3>
            <div style="display:flex;gap:8px;align-items:center">
                <label>Filter:</label>
                <select id="adminFilter">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="complete">Complete</option>
                </select>
            </div>
            <table id="adminOrdersTable">
                <thead>
                    <tr>
                        <th>UserID</th>
                        <th>Package</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Txn ID</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" class="loading">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
    </section>
</div>

<!-- BUY MODAL -->
<div class="modal" id="buyModal">
    <div class="box">
        <h3 id="buyTitle">‡¶°‡¶æ‡¶Ø‡¶º‡¶Æ‡¶®‡ßç‡¶° ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶ï‡¶ø‡¶®‡ßÅ‡¶®</h3>
        <label>Free Fire User ID / IGN</label>
        <input id="inputUID" placeholder="Enter FF User ID">
        <label>Package</label>
        <input id="inputPkg" readonly>
        <label>Package Type</label>
        <input id="inputPkgType" readonly>
        <label>Price</label>
        <input id="inputPrice" readonly>
        <label>Payment Transaction ID</label>
        <input id="inputTxn" placeholder="Enter transaction id">
        <label>Your Phone Number (Optional)</label>
        <input id="inputPhone" placeholder="Your phone number">
        <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="confirmBuy">Submit Order</button>
            <button class="btn gray" id="cancelBuy">Cancel</button>
        </div>
    </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="modal" id="adminModal">
    <div class="box">
        <h3>Admin Login</h3>
        <label>Admin Password</label>
        <input id="adminPass" type="password" placeholder="Enter admin password">
        <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="adminLoginBtn">Login</button>
            <button class="btn gray" id="closeAdminModal">Cancel</button>
        </div>
        <p class="note" style="margin-top:10px;text-align:center">
            Default Password: <strong>admin123</strong>
        </p>
    </div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div class="modal" id="changePasswordModal">
    <div class="box">
        <h3>Change Admin Password</h3>
        <label>Current Password</label>
        <input id="currentPassword" type="password" placeholder="Current password">
        <label>New Password</label>
        <input id="newPassword" type="password" placeholder="New password">
        <label>Confirm New Password</label>
        <input id="confirmNewPassword" type="password" placeholder="Confirm new password">
        <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="savePasswordBtn">Save Password</button>
            <button class="btn gray" id="cancelPasswordBtn">Cancel</button>
        </div>
    </div>
</div>

<script>
// Firebase Configuration - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Keys ‡¶¶‡¶ø‡ßü‡ßá
const firebaseConfig = {
    apiKey: "AIzaSyAoD00_UwAkLFka_JCSdGs4YuZOlCGw00c",
    authDomain: "tm-topup-33a29.firebaseapp.com",
    databaseURL: "https://tm-topup-33a29-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tm-topup-33a29",
    storageBucket: "tm-topup-33a29.firebasestorage.app",
    messagingSenderId: "1015484711011",
    appId: "1:1015484711011:web:155e43e096b8232850f856"
};

// Firebase Initialize
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Global Variables
let currentPackageType = 'diamond';
let currentEditingPackage = null;

const el = id => document.getElementById(id);

// Initialize Default Data
function initializeDefaultData() {
    // Check and set admin password
    database.ref('admin/password').once('value')
        .then(snapshot => {
            if (!snapshot.exists()) {
                database.ref('admin/password').set('admin123')
                    .then(() => console.log('Default admin password set'));
            }
        });

    // Check and set default packages
    database.ref('packages').once('value')
        .then(snapshot => {
            if (!snapshot.exists()) {
                const defaultPackages = {
                    diamond: {
                        pkg1: { id: 'pkg1', name: '60 Diamonds', price: 100, type: 'diamond' },
                        pkg2: { id: 'pkg2', name: '125 Diamonds', price: 200, type: 'diamond' },
                        pkg3: { id: 'pkg3', name: '500 Diamonds', price: 800, type: 'diamond' }
                    },
                    weekly: {
                        pkg1: { id: 'pkg1', name: 'Weekly Pass', price: 500, type: 'weekly' },
                        pkg2: { id: 'pkg2', name: 'Monthly Pass', price: 1800, type: 'weekly' }
                    }
                };
                database.ref('packages').set(defaultPackages)
                    .then(() => console.log('Default packages set'));
            }
        });

    // Check and set default appearance
    database.ref('website/appearance').once('value')
        .then(snapshot => {
            if (!snapshot.exists()) {
                const defaultAppearance = {
                    logoUrl: 'https://i.imgur.com/3UvHYH2.jpeg',
                    bannerUrl: '',
                    businessName: 'TM TOPUP - Free Fire Diamond',
                    businessTagline: 'Your Trusted Diamond Provider',
                    contactNumber: '+8801755368404',
                    whatsappNumber: '+8801755368404'
                };
                database.ref('website/appearance').set(defaultAppearance)
                    .then(() => console.log('Default appearance set'));
            }
        });
}

// Load Website Appearance
function loadWebsiteAppearance() {
    database.ref('website/appearance').once('value')
        .then(snapshot => {
            const appearance = snapshot.val();
            if (appearance) {
                // Load Logo
                if (appearance.logoUrl) {
                    el('logoImage').src = appearance.logoUrl;
                    el('logoUrl').value = appearance.logoUrl;
                }
                
                // Load Banner
                if (appearance.bannerUrl) {
                    el('bannerImage').src = appearance.bannerUrl;
                    el('bannerContainer').classList.remove('hidden');
                    el('bannerUrl').value = appearance.bannerUrl;
                }
                
                // Load Business Info
                if (appearance.businessName) {
                    el('businessName').textContent = appearance.businessName;
                    el('businessNameInput').value = appearance.businessName;
                }
                if (appearance.businessTagline) {
                    el('businessTagline').textContent = appearance.businessTagline;
                    el('businessTaglineInput').value = appearance.businessTagline;
                }
                
                // Load Contact Info
                if (appearance.contactNumber) {
                    el('contactNumber').value = appearance.contactNumber;
                }
                if (appearance.whatsappNumber) {
                    el('whatsappNumber').value = appearance.whatsappNumber;
                    updateInstructions(appearance.contactNumber, appearance.whatsappNumber);
                }
            }
        })
        .catch(error => {
            console.error('Error loading appearance:', error);
        });
}

// Update Logo
function updateLogo() {
    const logoUrl = el('logoUrl').value.trim();
    if (logoUrl) {
        database.ref('website/appearance/logoUrl').set(logoUrl)
            .then(() => {
                el('logoImage').src = logoUrl;
                alert('Logo updated successfully!');
            })
            .catch(error => {
                alert('Error updating logo: ' + error.message);
            });
    } else {
        alert('Please enter a valid logo URL');
    }
}

// Update Banner
function updateBanner() {
    const bannerUrl = el('bannerUrl').value.trim();
    database.ref('website/appearance/bannerUrl').set(bannerUrl)
        .then(() => {
            if (bannerUrl) {
                el('bannerImage').src = bannerUrl;
                el('bannerContainer').classList.remove('hidden');
            } else {
                el('bannerContainer').classList.add('hidden');
            }
            alert('Banner updated successfully!');
        })
        .catch(error => {
            alert('Error updating banner: ' + error.message);
        });
}

// Update Business Info
function updateBusinessInfo() {
    const businessName = el('businessNameInput').value.trim();
    const businessTagline = el('businessTaglineInput').value.trim();
    
    if (businessName) {
        database.ref('website/appearance').update({
            businessName: businessName,
            businessTagline: businessTagline
        })
        .then(() => {
            el('businessName').textContent = businessName;
            el('businessTagline').textContent = businessTagline;
            alert('Business info updated successfully!');
        })
        .catch(error => {
            alert('Error updating business info: ' + error.message);
        });
    } else {
        alert('Please enter a business name');
    }
}

// Update Contact Info
function updateContactInfo() {
    const contactNumber = el('contactNumber').value.trim();
    const whatsappNumber = el('whatsappNumber').value.trim();
    
    database.ref('website/appearance').update({
        contactNumber: contactNumber,
        whatsappNumber: whatsappNumber
    })
    .then(() => {
        updateInstructions(contactNumber, whatsappNumber);
        alert('Contact info updated successfully!');
    })
    .catch(error => {
        alert('Error updating contact info: ' + error.message);
    });
}

// Update Instructions
function updateInstructions(contactNumber, whatsappNumber) {
    const instructions = document.querySelector('.instructions');
    if (instructions) {
        instructions.innerHTML = `
            <p><strong>‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá:</strong> ${contactNumber} ‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏‡ßá Transaction ID ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p>
            <p><strong>‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®:</strong> ${whatsappNumber}</p>
        `;
    }
}

// Package Type Tabs
function showPackageType(type) {
    currentPackageType = type;
    
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Show/hide package sections
    el('diamondPackages').classList.add('hidden');
    el('weeklyPackages').classList.add('hidden');
    el(type + 'Packages').classList.remove('hidden');
    
    loadPackages(type);
}

// Load Packages from Firebase
function loadPackages(type = 'diamond') {
    const container = el(type + 'PackagesContainer');
    container.innerHTML = '<div class="loading">Loading packages...</div>';
    
    database.ref('packages/' + type).once('value')
        .then(snapshot => {
            const packages = snapshot.val();
            container.innerHTML = '';
            
            if (!packages) {
                container.innerHTML = '<p>No packages available</p>';
                return;
            }
            
            Object.keys(packages).forEach(key => {
                const pkg = packages[key];
                const div = document.createElement('div');
                div.className = 'package card';
                div.innerHTML = `
                    <div><strong>${pkg.name}</strong></div>
                    <div class="package-type">${type === 'diamond' ? 'üíé Diamond' : 'üìÖ Weekly'}</div>
                    <div class="price">‡ß≥${pkg.price}</div>
                    <div style="margin-top:auto">
                        <button class="btn" onclick="openBuyModal('${type}', '${key}')">Buy Now</button>
                    </div>
                `;
                container.appendChild(div);
            });
        })
        .catch(error => {
            console.error('Error loading packages:', error);
            container.innerHTML = '<p>Error loading packages</p>';
        });
}

// Open Buy Modal
function openBuyModal(type, packageKey) {
    database.ref('packages/' + type + '/' + packageKey).once('value')
        .then(snapshot => {
            const pkg = snapshot.val();
            if (pkg) {
                el('buyModal').style.display = 'flex';
                el('buyTitle').innerText = 'Buy ' + pkg.name;
                el('inputPkg').value = pkg.name;
                el('inputPkgType').value = type;
                el('inputPrice').value = pkg.price;
                el('inputUID').value = '';
                el('inputTxn').value = '';
                el('inputPhone').value = '';
                currentEditingPackage = { type, key: packageKey, ...pkg };
            }
        });
}

// Close Buy Modal
el('cancelBuy').addEventListener('click', () => {
    el('buyModal').style.display = 'none';
});

// Submit Order
el('confirmBuy').addEventListener('click', () => {
    const uid = el('inputUID').value.trim();
    const txn = el('inputTxn').value.trim();
    const pkgName = el('inputPkg').value;
    const pkgType = el('inputPkgType').value;
    const price = el('inputPrice').value;
    const phone = el('inputPhone').value.trim();

    if (!uid || !txn) {
        alert('User ID ‡¶è‡¶¨‡¶Ç Transaction ID ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá');
        return;
    }

    const orderData = {
        userID: uid,
        packageName: pkgName,
        packageType: pkgType,
        packagePrice: price,
        transactionID: txn,
        phone: phone || 'Not provided',
        status: 'pending',
        date: new Date().toLocaleString('bn-BD'),
        timestamp: Date.now()
    };

    // Save to Firebase
    const newOrderRef = database.ref('orders').push();
    newOrderRef.set(orderData)
        .then(() => {
            alert('‚úÖ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
            el('buyModal').style.display = 'none';
            showOrderNotification(uid, pkgName, txn);
        })
        .catch(error => {
            alert('‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message);
        });
});

// Show Order Notification
function showOrderNotification(uid, pkgName, txn) {
    const notification = document.createElement('div');
    notification.className = 'order-notification';
    notification.innerHTML = `
        <strong>‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßç‡¶°!</strong>
        <p>User ID: ${uid}</p>
        <p>Package: ${pkgName}</p>
        <p>Txn ID: ${txn}</p>
        <p>TM TOPUP ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶ï‡¶®‡ßç‡¶ü‡¶æ‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá</p>
    `;
    el('userSection').insertBefore(notification, el('userSection').firstChild);
    setTimeout(() => { notification.remove(); }, 10000);
}

// Admin Login
el('openAdminBtn').addEventListener('click', () => {
    el('adminModal').style.display = 'flex';
});

el('closeAdminModal').addEventListener('click', () => {
    el('adminModal').style.display = 'none';
});

el('adminLoginBtn').addEventListener('click', () => {
    const password = el('adminPass').value;
    
    database.ref('admin/password').once('value')
        .then(snapshot => {
            const adminPassword = snapshot.val();
            if (password === adminPassword) {
                el('adminModal').style.display = 'none';
                showAdminPanel();
            } else {
                alert('Invalid password');
            }
        })
        .catch(error => {
            alert('Login error: ' + error.message);
        });
});

// Show Admin Panel
function showAdminPanel() {
    el('userSection').classList.add('hidden');
    el('allOrdersSection').classList.add('hidden');
    el('adminPanel').classList.remove('hidden');
    loadAdminPackages();
    loadAdminOrders();
}

// Load Admin Packages
function loadAdminPackages() {
    loadAdminPackageType('diamond');
    loadAdminPackageType('weekly');
}

function loadAdminPackageType(type) {
    const container = el('admin' + type.charAt(0).toUpperCase() + type.slice(1) + 'PackageList');
    container.innerHTML = '<div class="loading">Loading...</div>';
    
    database.ref('packages/' + type).once('value')
        .then(snapshot => {
            const packages = snapshot.val();
            container.innerHTML = '';
            
            if (!packages) {
                container.innerHTML = '<p>No packages</p>';
                return;
            }
            
            Object.keys(packages).forEach(key => {
                const pkg = packages[key];
                container.innerHTML += `
                    <div style="display:flex;gap:8px;align-items:center;margin:4px 0;padding:8px;background:#f8f9fa;border-radius:6px">
                        <span>${pkg.name} - ‡ß≥${pkg.price}</span>
                        <button class="btn gray" onclick="deletePackage('${type}', '${key}')" style="margin-left:auto">Delete</button>
                    </div>
                `;
            });
        });
}

// Add Diamond Package
el('addDiamondPkgBtn').addEventListener('click', () => {
    const name = el('newDiamondPkgName').value.trim();
    const price = parseInt(el('newDiamondPkgPrice').value);
    
    if (!name || isNaN(price)) {
        alert('Please enter valid package name and price');
        return;
    }
    
    const newPackage = {
        name: name,
        price: price,
        type: 'diamond'
    };
    
    database.ref('packages/diamond').push().set(newPackage)
        .then(() => {
            alert('Package added successfully');
            el('newDiamondPkgName').value = '';
            el('newDiamondPkgPrice').value = '';
            loadAdminPackages();
            loadPackages('diamond');
        })
        .catch(error => {
            alert('Error adding package: ' + error.message);
        });
});

// Add Weekly Package
el('addWeeklyPkgBtn').addEventListener('click', () => {
    const name = el('newWeeklyPkgName').value.trim();
    const price = parseInt(el('newWeeklyPkgPrice').value);
    
    if (!name || isNaN(price)) {
        alert('Please enter valid package name and price');
        return;
    }
    
    const newPackage = {
        name: name,
        price: price,
        type: 'weekly'
    };
    
    database.ref('packages/weekly').push().set(newPackage)
        .then(() => {
            alert('Package added successfully');
            el('newWeeklyPkgName').value = '';
            el('newWeeklyPkgPrice').value = '';
            loadAdminPackages();
            loadPackages('weekly');
        })
        .catch(error => {
            alert('Error adding package: ' + error.message);
        });
});

// Delete Package
function deletePackage(type, key) {
    if (confirm('Are you sure you want to delete this package?')) {
        database.ref('packages/' + type + '/' + key).remove()
            .then(() => {
                alert('Package deleted successfully');
                loadAdminPackages();
                loadPackages(type);
            })
            .catch(error => {
                alert('Error deleting package: ' + error.message);
            });
    }
}

// Load Admin Orders
function loadAdminOrders() {
    const tbody = el('adminOrdersTable').querySelector('tbody');
    tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading...</td></tr>';
    
    database.ref('orders').orderByChild('timestamp').once('value')
        .then(snapshot => {
            const orders = snapshot.val();
            tbody.innerHTML = '';
            
            if (!orders) {
                tbody.innerHTML = '<tr><td colspan="9">No orders found</td></tr>';
                return;
            }
            
            const filter = el('adminFilter').value;
            let hasOrders = false;
            
            Object.keys(orders).forEach(key => {
                const order = orders[key];
                
                if (filter === 'all' || order.status === filter) {
                    hasOrders = true;
                    tbody.innerHTML += `
                        <tr>
                            <td>${order.userID}</td>
                            <td>${order.packageName}</td>
                            <td>${order.packageType}</td>
                            <td>‡ß≥${order.packagePrice}</td>
                            <td>${order.transactionID}</td>
                            <td>${order.phone}</td>
                            <td><span class="status-${order.status}">${order.status}</span></td>
                            <td>${order.date}</td>
                            <td>
                                <button class="btn" onclick="updateOrderStatus('${key}', 'complete')">Complete</button>
                                <button class="btn gray" onclick="updateOrderStatus('${key}', 'pending')" style="margin-top:4px">Pending</button>
                            </td>
                        </tr>
                    `;
                }
            });
            
            if (!hasOrders) {
                tbody.innerHTML = '<tr><td colspan="9">No orders found</td></tr>';
            }
        });
}

// Update Order Status
function updateOrderStatus(orderKey, status) {
    database.ref('orders/' + orderKey + '/status').set(status)
        .then(() => {
            alert('Order status updated to: ' + status);
            loadAdminOrders();
        })
        .catch(error => {
            alert('Error updating order: ' + error.message);
        });
}

// Filter Orders
el('adminFilter').addEventListener('change', loadAdminOrders);

// Change Password
el('changeCredentialsBtn').addEventListener('click', () => {
    el('changePasswordModal').style.display = 'flex';
});

el('cancelPasswordBtn').addEventListener('click', () => {
    el('changePasswordModal').style.display = 'none';
});

el('savePasswordBtn').addEventListener('click', () => {
    const currentPass = el('currentPassword').value;
    const newPass = el('newPassword').value;
    const confirmPass = el('confirmNewPassword').value;
    
    if (!currentPass || !newPass || !confirmPass) {
        alert('Please fill all fields');
        return;
    }
    
    if (newPass !== confirmPass) {
        alert('New passwords do not match');
        return;
    }
    
    database.ref('admin/password').once('value')
        .then(snapshot => {
            const currentAdminPass = snapshot.val();
            if (currentPass !== currentAdminPass) {
                alert('Current password is incorrect');
                return;
            }
            
            database.ref('admin/password').set(newPass)
                .then(() => {
                    alert('Password changed successfully');
                    el('changePasswordModal').style.display = 'none';
                    el('currentPassword').value = '';
                    el('newPassword').value = '';
                    el('confirmNewPassword').value = '';
                })
                .catch(error => {
                    alert('Error changing password: ' + error.message);
                });
        });
});

// Logout Admin
el('logoutAdmin').addEventListener('click', () => {
    if (confirm('Logout admin?')) {
        el('adminPanel').classList.add('hidden');
        el('userSection').classList.remove('hidden');
    }
});

// Refresh Admin Data
el('refreshAdminData').addEventListener('click', () => {
    loadAdminPackages();
    loadAdminOrders();
});

// View All Orders (User)
el('viewAllOrdersBtn').addEventListener('click', () => {
    const password = prompt('Enter admin password:');
    database.ref('admin/password').once('value')
        .then(snapshot => {
            const adminPassword = snapshot.val();
            if (password === adminPassword) {
                showAllOrders();
            } else {
                alert('Invalid password');
            }
        });
});

// Show All Orders
function showAllOrders() {
    el('userSection').classList.add('hidden');
    el('allOrdersSection').classList.remove('hidden');
    loadAllOrders();
}

// Load All Orders
function loadAllOrders() {
    const ordersList = el('ordersList');
    ordersList.innerHTML = '<div class="loading">Loading orders...</div>';
    
    database.ref('orders').orderByChild('timestamp').once('value')
        .then(snapshot => {
            const orders = snapshot.val();
            ordersList.innerHTML = '';
            
            if (!orders) {
                ordersList.innerHTML = '<p>No orders found</p>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User ID</th>
                            <th>Package</th>
                            <th>Type</th>
                            <th>Price</th>
                            <th>Txn ID</th>
                            <th>Phone</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(orders).forEach(key => {
                const order = orders[key];
                html += `
                    <tr>
                        <td>${order.date}</td>
                        <td>${order.userID}</td>
                        <td>${order.packageName}</td>
                        <td>${order.packageType}</td>
                        <td>‡ß≥${order.packagePrice}</td>
                        <td>${order.transactionID}</td>
                        <td>${order.phone}</td>
                        <td><span class="status-${order.status}">${order.status}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            ordersList.innerHTML = html;
        })
        .catch(error => {
            ordersList.innerHTML = '<p>Error loading orders</p>';
        });
}

// Back to Shop
el('backToShopFromAdmin').addEventListener('click', () => {
    el('allOrdersSection').classList.add('hidden');
    el('userSection').classList.remove('hidden');
});

// Refresh Orders
el('refreshOrdersBtn').addEventListener('click', loadAllOrders);

// Manage Appearance Button
el('manageAppearanceBtn').addEventListener('click', () => {
    document.querySelector('.admin-section').scrollIntoView({ behavior: 'smooth' });
});

// Initial Load
window.onload = function() {
    initializeDefaultData();
    loadWebsiteAppearance();
    loadPackages('diamond');
};
</script>
</body>
</html>